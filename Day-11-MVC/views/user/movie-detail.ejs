<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>

        <!-- Movie Hero -->
        <section class="movie-hero">
            <div class="backdrop">
                <img src="<%= movie.backdrop || movie.poster || '' %>" alt="<%= movie.title %>"
                    onerror="this.style.display='none'">
            </div>
            <div class="container">
                <div class="hero-detail">
                    <div class="detail-poster">
                        <img src="<%= movie.poster || '' %>" alt="<%= movie.title %>"
                            onerror="this.src='https://via.placeholder.com/300x450/1a1a2e/7c3aed?text=No+Poster'">
                    </div>
                    <div class="detail-info">
                        <h1>
                            <%= movie.title %>
                        </h1>
                        <div class="detail-meta">
                            <span>üìÖ <%= new Date(movie.releaseDate).getFullYear() %></span>
                            <% if (movie.runtime) { %><span>‚è± <%= Math.floor(movie.runtime/60) %>h <%= movie.runtime%60
                                            %>m</span>
                                <% } %>
                                    <span>üé¨ <%= movie.director %></span>
                                    <span>üåê <%= movie.language %></span>
                                    <% if (movie.era) { %><span>üìÜ <%= movie.era %></span>
                                        <% } %>
                        </div>
                        <div style="display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom:0.8rem;">
                            <% (movie.genres || []).forEach(g=> { %><span class="genre-tag">
                                    <%= g %>
                                </span>
                                <% }) %>
                                    <% (movie.mood || []).forEach(m=> { %><span class="mood-tag">
                                            <%= m %>
                                        </span>
                                        <% }) %>
                        </div>
                        <div style="display:flex; gap:0.8rem; flex-wrap:wrap;">
                            <% if (isAuthenticated) { %>
                                <button class="btn btn-primary" onclick="showWatchlistModal()">
                                    <%= watchlistEntry ? 'üìã In Watchlist' : '‚ûï Add to Watchlist' %>
                                </button>
                                <% } %>
                                    <a href="#reviews" class="btn btn-outline">üìù Reviews (<%= reviews.length %>)</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="container section">
            <!-- Overview -->
            <div style="max-width:800px; margin-bottom:2.5rem;">
                <h2 class="section-title" style="margin-bottom:1rem;">üìñ Overview</h2>
                <p style="color:var(--text-secondary); line-height:1.8; font-size:0.95rem;">
                    <%= movie.overview %>
                </p>
            </div>

            <!-- Ratings Breakdown -->
            <% if (movie.ratings && movie.ratings.count> 0) { %>
                <div style="margin-bottom:2.5rem;">
                    <h2 class="section-title" style="margin-bottom:1rem;">‚≠ê Ratings (<%= movie.ratings.count %> reviews)
                    </h2>
                    <div class="rating-breakdown">
                        <div class="rating-item">
                            <div class="value">
                                <%= movie.ratings.overall.toFixed(1) %>
                            </div>
                            <div class="label">Overall</div>
                        </div>
                        <div class="rating-item">
                            <div class="value">
                                <%= movie.ratings.direction.toFixed(1) %>
                            </div>
                            <div class="label">Direction</div>
                        </div>
                        <div class="rating-item">
                            <div class="value">
                                <%= movie.ratings.acting.toFixed(1) %>
                            </div>
                            <div class="label">Acting</div>
                        </div>
                        <div class="rating-item">
                            <div class="value">
                                <%= movie.ratings.visuals.toFixed(1) %>
                            </div>
                            <div class="label">Visuals</div>
                        </div>
                        <div class="rating-item">
                            <div class="value">
                                <%= movie.ratings.story.toFixed(1) %>
                            </div>
                            <div class="label">Story</div>
                        </div>
                    </div>
                </div>
                <% } %>

                    <!-- Cast -->
                    <% if (movie.cast && movie.cast.length> 0) { %>
                        <div style="margin-bottom:2.5rem;">
                            <h2 class="section-title" style="margin-bottom:1rem;">üé≠ Cast</h2>
                            <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                                <% movie.cast.forEach(c=> { %>
                                    <div
                                        style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:0.8rem 1.2rem; min-width:150px;">
                                        <div style="font-weight:600; font-size:0.9rem;">
                                            <%= c.name %>
                                        </div>
                                        <div style="font-size:0.8rem; color:var(--text-muted);">
                                            <%= c.character %>
                                        </div>
                                    </div>
                                    <% }) %>
                            </div>
                        </div>
                        <% } %>

                            <!-- Reviews Section -->
                            <div id="reviews" style="margin-bottom:2.5rem;">
                                <h2 class="section-title" style="margin-bottom:1.5rem;">üìù Reviews</h2>

                                <% if (isAuthenticated && !userReview) { %>
                                    <!-- Review Form -->
                                    <div class="review-card" style="margin-bottom:2rem; border-color:var(--accent);">
                                        <h3 style="font-family:var(--font-heading); margin-bottom:1rem;">Write a Review
                                        </h3>
                                        <form action="/movie/<%= movie._id %>/review" method="POST" id="reviewForm">
                                            <div class="form-group">
                                                <label class="form-label">Review Title</label>
                                                <input type="text" name="title" class="form-input"
                                                    placeholder="Sum up your thoughts..." required maxlength="150">
                                            </div>
                                            <div
                                                style="display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:1rem; margin-bottom:1rem;">
                                                <% ['direction','acting','visuals','story','overall'].forEach(dim=> { %>
                                                    <div>
                                                        <label class="form-label" style="text-transform:capitalize;">
                                                            <%= dim %>
                                                        </label>
                                                        <div class="stars" data-field="<%= dim %>">
                                                            <% for(let i=1; i<=5; i++) { %>
                                                                <span class="star" data-value="<%= i %>"
                                                                    onclick="setRating('<%= dim %>', <%= i %>)">‚òÖ</span>
                                                                <% } %>
                                                        </div>
                                                        <input type="hidden" name="<%= dim %>" id="rating-<%= dim %>"
                                                            value="" required>
                                                    </div>
                                                    <% }) %>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Your Review</label>
                                                <textarea name="content" class="form-textarea"
                                                    placeholder="Share your thoughts about this movie..." required
                                                    maxlength="3000" rows="4"></textarea>
                                            </div>
                                            <div style="display:flex; align-items:center; gap:1rem;">
                                                <label
                                                    style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; font-size:0.85rem; color:var(--text-secondary);">
                                                    <input type="checkbox" name="spoiler"> Contains spoilers
                                                </label>
                                                <button type="submit" class="btn btn-primary">Submit Review</button>
                                            </div>
                                        </form>
                                    </div>
                                    <% } %>

                                        <% if (reviews.length> 0) { %>
                                            <% reviews.forEach(r=> { %>
                                                <div class="review-card">
                                                    <div class="review-header">
                                                        <div class="review-avatar">
                                                            <%= r.user?.username?.charAt(0).toUpperCase() || '?' %>
                                                        </div>
                                                        <div>
                                                            <div class="username">
                                                                <%= r.user?.username || 'Anonymous' %>
                                                            </div>
                                                            <div class="date">
                                                                <%= new Date(r.createdAt).toLocaleDateString('en-US', {
                                                                    year:'numeric', month:'short', day:'numeric' }) %>
                                                            </div>
                                                        </div>
                                                        <div style="margin-left:auto; display:flex; gap:0.5rem;">
                                                            <span class="rating-badge" style="position:static;">‚≠ê <%=
                                                                    r.ratings.overall %></span>
                                                            <% if (r.spoiler) { %><span
                                                                    class="status-badge status-dropped">Spoiler</span>
                                                                <% } %>
                                                        </div>
                                                    </div>
                                                    <h4>
                                                        <%= r.title %>
                                                    </h4>
                                                    <p class="review-text">
                                                        <%= r.content %>
                                                    </p>
                                                    <div class="review-actions">
                                                        <% if (isAuthenticated) { %>
                                                            <button class="btn btn-ghost btn-sm"
                                                                onclick="toggleLike('<%= r._id %>', this)">
                                                                ‚ù§Ô∏è <span>
                                                                    <%= r.likes?.length || 0 %>
                                                                </span>
                                                            </button>
                                                            <% } else { %>
                                                                <span
                                                                    style="font-size:0.8rem; color:var(--text-muted);">‚ù§Ô∏è
                                                                    <%= r.likes?.length || 0 %> likes</span>
                                                                <% } %>
                                                    </div>
                                                </div>
                                                <% }) %>
                                                    <% } else { %>
                                                        <div class="empty-state" style="padding:2rem;">
                                                            <div class="icon">üìù</div>
                                                            <h3>No reviews yet</h3>
                                                            <p>Be the first to review this movie!</p>
                                                        </div>
                                                        <% } %>
                            </div>

                            <!-- Similar Movies -->
                            <% if (similarMovies.length> 0) { %>
                                <div>
                                    <h2 class="section-title" style="margin-bottom:1rem;">üéûÔ∏è Similar Movies</h2>
                                    <div class="movie-grid">
                                        <% similarMovies.forEach(movie=> { %>
                                            <%- include('../partials/movie-card', { movie }) %>
                                                <% }) %>
                                    </div>
                                </div>
                                <% } %>
        </div>

        <!-- Watchlist Modal -->
        <% if (isAuthenticated) { %>
            <div class="modal-overlay" id="watchlistModal">
                <div class="modal">
                    <h2>
                        <%= watchlistEntry ? 'Update Watchlist' : 'Add to Watchlist' %>
                    </h2>
                    <form id="watchlistForm">
                        <input type="hidden" name="movieId" value="<%= movie._id %>">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="plan_to_watch" <%=watchlistEntry?.status==='plan_to_watch' ?'selected':''
                                    %>>Plan to Watch</option>
                                <option value="watching" <%=watchlistEntry?.status==='watching' ?'selected':'' %>
                                    >Watching</option>
                                <option value="completed" <%=watchlistEntry?.status==='completed' ?'selected':'' %>
                                    >Completed</option>
                                <option value="on_hold" <%=watchlistEntry?.status==='on_hold' ?'selected':'' %>>On Hold
                                </option>
                                <option value="dropped" <%=watchlistEntry?.status==='dropped' ?'selected':'' %>>Dropped
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select name="priority" class="form-select">
                                <option value="low" <%=watchlistEntry?.priority==='low' ?'selected':'' %>>Low</option>
                                <option value="medium" <%=watchlistEntry?.priority==='medium' ?'selected':'' %>>Medium
                                </option>
                                <option value="high" <%=watchlistEntry?.priority==='high' ?'selected':'' %>>High
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-textarea" rows="2"
                                placeholder="Personal notes..."><%= watchlistEntry?.notes || '' %></textarea>
                        </div>
                        <div style="display:flex; gap:0.8rem;">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-ghost" onclick="closeWatchlistModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            <% } %>

                <%- include('../partials/footer') %>